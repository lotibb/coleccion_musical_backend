# Coleccion Musical Backend

Node.js service that exposes a REST API to manage musical artists and albums stored in PostgreSQL. The project is ready to run locally, deploy to Render, and consume from tools such as Postman or curl.

## Tech Stack

- Node.js 18+
- Express 4
- PostgreSQL 13+
- pg connection pool
- dotenv for environment management
- cors middleware
- nodemon for hot reload during development

## Project Layout

```
coleccion_musical_backend/
  config/
    database.js        # Connection pool and database helpers
  server.js            # Express app and HTTP routes
  openapi.yaml         # OpenAPI 3 contract
  package.json         # Scripts and dependencies
  package-lock.json
  .env                 # Local environment variables (ignored by git)
  README.md            # Project documentation
```
node_modules/ is generated locally after running `npm install`.

## Requirements

1. Node.js 18 or later (matches the `engines` field).
2. npm 8+ (ships with Node 18) or yarn.
3. PostgreSQL database reachable from the machine that runs the API.
4. Optional: Render account if you want to deploy there.

## Setup

1. Clone the repository and install dependencies.
   ```bash
   git clone <repository-url>
   cd coleccion_musical_backend
   npm install
   ```
2. Create a `.env` file in the project root.
   ```env
   # Choose one of the following connection styles
   DATABASE_URL=postgres://user:password@host:5432/database
   # or provide the pieces separately
   DB_HOST=hostname
   DB_PORT=5432
   DB_NAME=database
   DB_USER=user
   DB_PASSWORD=password

   # Optional overrides
   PORT=3000
   NODE_ENV=development
   ```
3. Ensure the database has the tables shown below before starting the server.

## Database Schema

```sql
CREATE TABLE artista (
  id_artista INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre VARCHAR(100) NOT NULL,
  genero_musica VARCHAR(100) NOT NULL
);

CREATE TABLE albumes (
  id_album INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  titulo_album VARCHAR(100) NOT NULL,
  anio_album INT NOT NULL,
  id_artista INT NOT NULL REFERENCES artista(id_artista)
    ON UPDATE CASCADE
    ON DELETE RESTRICT
);

-- Recommended uniqueness guards
CREATE UNIQUE INDEX IF NOT EXISTS artista_nombre_unique_ci
  ON artista (LOWER(nombre));

CREATE UNIQUE INDEX IF NOT EXISTS albumes_titulo_unique_ci
  ON albumes (LOWER(titulo_album));
```

When importing seed data manually, keep identity sequences in sync so automatic ids do not collide:
```sql
SELECT setval(pg_get_serial_sequence('artista', 'id_artista'),
              COALESCE((SELECT MAX(id_artista) FROM artista), 0));
SELECT setval(pg_get_serial_sequence('albumes', 'id_album'),
              COALESCE((SELECT MAX(id_album) FROM albumes), 0));
```

## Running the Server

- Development (auto reload):
  ```bash
  npm run dev
  ```
- Production style:
  ```bash
  npm start
  ```

The server binds to `localhost` in development and to `0.0.0.0` when `NODE_ENV=production` or the `RENDER` environment variable is present.

## API Reference

Every JSON response is wrapped by the helper `{ status, message, data?, timestamp }`.

Interactive documentation is available at `http://localhost:3000/api/docs` once the server is running. It is generated from the OpenAPI definition in `openapi.yaml` using Swagger UI.

### Health and Info

- `GET /` returns `OK!` to confirm the service is accessible.
- `GET /api/health` checks the PostgreSQL connection.

Example:
```json
{
  "status": "success",
  "message": "Database connection successful",
  "data": {
    "database": {
      "connected": true,
      "currentTime": "2025-09-29T21:30:00.000Z",
      "postgresVersion": "PostgreSQL 15.4",
      "host": "example-host",
      "database": "coleccion"
    }
  },
  "timestamp": "2025-09-29T21:30:00.000Z"
}
```

### Artists

- `GET /api/artistas`
  - Returns all artists sorted alphabetically.
- `POST /api/agregar_artista`
  - Body:
    ```json
    {
      "nombre": "Artista",
      "genero_musica": "Rock"
    }
    ```
  - Responses: `201 Created` on success, `400` when required fields are missing, `409` if the name already exists (enforced when the database index is present).
- `PATCH /api/artistas/:id`
  - Body accepts any combination of the following fields:
    ```json
    {
      "nombre": "Nombre opcional",
      "genero_musica": "Genero opcional"
    }
    ```
  - Responses: `200` with the updated artist, `400` for invalid input, `404` if the id does not exist, `409` when the new name conflicts with another artist.
- `GET /api/artistas/nombre/:nombre/albumes`
  - Looks up the artist by name (case insensitive) and returns their albums.
  - `404` when the artist does not exist. Returns an empty `albumes` array with a success status if the artist is found but has no albums yet.

### Albums

- `GET /api/albumes`
  - Returns every album sorted by title.
- `POST /api/agregar_album`
  - Body:
    ```json
    {
      "titulo_album": "Album",
      "anio_album": 2024,
      "id_artista": 26
    }
    ```
  - Responses: `201` on success, `400` for missing or invalid fields, `404` when `id_artista` does not exist, `409` if the album title is already in use.
- `PATCH /api/albumes/:id`
  - Body accepts any combination of `titulo_album`, `anio_album`, and `id_artista`.
  - Responses mirror the artist patch endpoint: `200` on success, `400` for invalid payload, `404` for unknown album (or unknown artist when changing the owner), `409` for duplicate titles.

### Musical Collection Aggregates

- `GET /api/coleccion_musical`
  - Returns each artist with the albums nested under `albumes`.
  - Example snippet:
    ```json
    {
      "status": "success",
      "message": "Musical collection retrieved",
      "data": {
        "artistas": [
          {
            "id_artista": 1,
            "nombre": "Ed Maverick",
            "genero_musica": "Independiente",
            "albumes": [
              {
                "id_album": 10,
                "titulo_album": "Eduardo",
                "anio_album": 2021
              }
            ]
          }
        ]
      },
      "timestamp": "2025-09-29T21:30:00.000Z"
    }
    ```

## Common Workflows

### Start the server and smoke test
```bash
npm run dev
curl http://localhost:3000/
curl http://localhost:3000/api/health
```

### Create sample data
```bash
curl -X POST http://localhost:3000/api/agregar_artista \
  -H "Content-Type: application/json" \
  -d '{"nombre":"Ed Maverick","genero_musica":"Independiente"}'

curl -X POST http://localhost:3000/api/agregar_album \
  -H "Content-Type: application/json" \
  -d '{"titulo_album":"Eduardo","anio_album":2021,"id_artista":26}'
```

### Update existing records
```bash
curl -X PATCH http://localhost:3000/api/artistas/26 \
  -H "Content-Type: application/json" \
  -d '{"genero_musica":"Indie Folk"}'

curl -X PATCH http://localhost:3000/api/albumes/12 \
  -H "Content-Type: application/json" \
  -d '{"titulo_album":"Eduardo (Deluxe)"}'
```

### Query albums for a given artist
```bash
curl http://localhost:3000/api/artistas/nombre/Ed%20Maverick/albumes
```

## Deployment Notes

- Render deployment works with the default scripts:
  - Build command: `npm install`
  - Start command: `npm start`
- Render exposes the database URL via the `DATABASE_URL` variable; leave SSL enabled (`rejectUnauthorized: false`) if you use Render PostgreSQL.
- Make sure environment variables are added through the Render dashboard.

## Troubleshooting

| Issue | Checks |
| ----- | ------ |
| `Failed to fetch albumes/artistas` | Confirm the database credentials in `.env` and that the server can reach the host/port. |
| `duplicate key value violates unique constraint` | Run the `setval` statements shown above to align identity sequences after manual inserts. |
| 409 conflict on artist or album updates | The chosen name/title is already in use. Pick a new value or delete the duplicate row. |
| 404 when creating an album | The `id_artista` provided does not exist. Create the artist first or use the correct id. |

## Roadmap Ideas

- Add automated tests (Jest or Supertest) for the endpoints.
- Introduce request validation middleware such as `zod` or `joi`.
- Provide pagination and filtering for large catalogues.
- Implement authentication if the API is exposed publicly.

## License

ISC
